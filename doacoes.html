<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Doa√ß√µes - Ajuda Processador</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
  <div class="banner">
    <h1>Meu PC quebrou üò¢</h1>
    <p class="frase-motivadora">"Um gesto pequeno para voc√™, um novo come√ßo para meu PC ‚Äî cada real conta!"</p>
  </div>

  <div class="card">
    <p id="bemvindo"></p>

    <h3>Foto e V√≠deo do PC</h3>
    <input id="photoUrl" placeholder="Link da foto">
    <input id="videoUrl" placeholder="Link do v√≠deo">
    <div id="media"></div>

    <h3>Doa√ß√£o</h3>
    <input id="valorDoacao" type="number" min="1" placeholder="Valor em R$">
    <input id="mensagemDoacao" type="text" placeholder="Mensagem opcional">
    <button id="btnDoar">Doar agora</button>
    <div id="codigo"></div>

    <h3>Ranking de Doadores</h3>
    <div id="leaderboard"></div>

    <button id="btnSair">Sair</button>
    <div id="mensagem"></div>
  </div>

  <div id="notificacoes"></div>
</div>

<script>
const SERVER_BASE='site-doacoespro-produ√ß√£o.up.railway.app';
const userStr=localStorage.getItem('usuarioLogado');
if(!userStr){ window.location.href='index.html'; }
else { var user=JSON.parse(userStr); document.getElementById('bemvindo').textContent='Bem-vindo(a), '+user.nome+'!'; }

document.getElementById('btnSair').addEventListener('click',()=>{
  localStorage.removeItem('usuarioLogado'); window.location.href='index.html';
});

// Media
const photoInput=document.getElementById('photoUrl');
const videoInput=document.getElementById('videoUrl');
const mediaDiv=document.getElementById('media');
function renderMedia(){
  mediaDiv.innerHTML='';
  if(photoInput.value.trim()){ const img=document.createElement('img'); img.src=photoInput.value.trim(); mediaDiv.appendChild(img);}
  if(videoInput.value.trim()){ const vid=document.createElement('video'); vid.controls=true; vid.src=videoInput.value.trim(); mediaDiv.appendChild(vid);}
}
photoInput.addEventListener('change',renderMedia);
videoInput.addEventListener('change',renderMedia);

// Ranking
function loadRanking(){
  fetch(`${SERVER_BASE}/ranking`).then(res=>res.json()).then(ranking=>{
      const lb=document.getElementById('leaderboard'); lb.innerHTML='';
      if(!ranking.length){ lb.innerHTML='<p>Nenhuma doa√ß√£o ainda.</p>'; return; }
      ranking.forEach((d,i)=>{
        const div=document.createElement('div'); div.className='donor';
        if(i===0) div.classList.add('gold');
        else if(i===1) div.classList.add('silver');
        else if(i===2) div.classList.add('bronze');
        div.textContent=`#${i+1} ${d.nome} ‚Äî R$${d.valor.toFixed(2)}${d.mensagem?` ‚Äî "${d.mensagem}"`:''}`;
        lb.appendChild(div);
      });
  }).catch(()=>document.getElementById('leaderboard').innerHTML='<p>Erro ao carregar ranking.</p>');
}

// Notifica√ß√£o
function mostrarNotificacao(nome,valor,mensagem){
  const nDiv=document.createElement('div');
  nDiv.innerHTML=`<strong>${nome}</strong> doou R$${valor.toFixed(2)}${mensagem?` ‚Äî "${mensagem}"`:''}`;
  if(valor>=100) nDiv.style.background='#fbbf24';
  else if(valor>=50) nDiv.style.background='#ef4444';
  else nDiv.style.background='#10b981';
  nDiv.style.color='#fff';
  nDiv.style.padding='12px';
  nDiv.style.margin='10px 0';
  nDiv.style.borderRadius='10px';
  nDiv.style.fontWeight='bold';
  nDiv.style.textAlign='center';
  nDiv.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)';
  nDiv.style.opacity=0;
  nDiv.style.transform='translateY(-20px)';
  nDiv.style.transition='opacity 0.5s ease, transform 0.5s ease';
  document.getElementById('notificacoes').prepend(nDiv);
  requestAnimationFrame(()=>{ nDiv.style.opacity=1; nDiv.style.transform='translateY(0)'; });
  setTimeout(()=>{ nDiv.style.opacity=0; nDiv.style.transform='translateY(-20px)'; setTimeout(()=> nDiv.remove(),500); },6000);
  const audio=new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg'); audio.play().catch(()=>{});
}

// Verificar novas doa√ß√µes
async function verificarNovasDoacoes(){
  try{
    const res=await fetch(`${SERVER_BASE}/ranking`);
    const ranking=await res.json();
    if(!ranking.length) return;
    const ultimaDoacao=ranking[0].valor;
    if(!localStorage.getItem('ultimaDoacao')) localStorage.setItem('ultimaDoacao',ultimaDoacao);
    const ultimaSalva=parseFloat(localStorage.getItem('ultimaDoacao'));
    if(ultimaDoacao>ultimaSalva){
      const top=ranking[0];
      mostrarNotificacao(top.nome,top.valor,top.mensagem||'');
      localStorage.setItem('ultimaDoacao',ultimaDoacao);
      loadRanking();
    }
  }catch(e){ console.error(e);}
}
setInterval(verificarNovasDoacoes,5000);

// Doa√ß√£o
document.getElementById('btnDoar').addEventListener('click', async ()=>{
  const valor=parseFloat(document.getElementById('valorDoacao').value);
  const mensagem=document.getElementById('mensagemDoacao').value.trim();
  if(isNaN(valor)||valor<1){ alert('Valor m√≠nimo R$1'); return; }
  try{
    const res=await fetch(`${SERVER_BASE}/criar-sessao`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({valor,nome:user.nome,email:user.email,mensagem})
    });
    const data=await res.json();
    if(data.checkoutCode){
      window.location.href=`https://pagseguro.uol.com.br/v2/checkout/payment.html?code=${data.checkoutCode}`;
    }else{
      document.getElementById('mensagem').textContent='Erro ao gerar checkout.';
    }
  }catch(e){ console.error(e); document.getElementById('mensagem').textContent='Erro de conex√£o.';}
});

loadRanking();
</script>
</body>
</html>
